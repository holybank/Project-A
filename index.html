<!DOCTYPE html>
<html>
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <title>Socket.IO chat</title>
    <style>
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages > li { padding: 0.5rem 1rem; }
      #messages > li:nth-child(odd) { background: #efefef; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="col">
          <div class="input-group mb-3">
            <input id="inputChangeNickname" type="text" class="form-control" placeholder="Nickname" aria-label="Nickname">
            <button class="btn btn-secondary" type="button" id="changeNicknameButton">Change Nickname</button>
          </div>
          <h3>Messages</h3>
          <ul id="messages"></ul>
        </div>
        <div class="col">
          <h3>Main</h3>
        </div>
        <div class="col">
          <h3>Users</h3>
          <ul id="userList" class="list-group"></ul>
        </div>
      </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      var socket = io();
      var users = [];

      function displayUsers(){
        document.getElementById('userList').innerHTML = ``;
        users.forEach(user => {
          document.getElementById('userList').innerHTML += `
            <li class="list-group-item">
              ${user.nickname}
            </li>
          `;
        });
      }

      document.getElementById('changeNicknameButton').addEventListener('click', function(e) {
        e.preventDefault();
        if (inputChangeNickname.value) {
          socket.emit('change nickname', inputChangeNickname.value);
          inputChangeNickname.value = '';
        }
      });

      socket.on('chat message', function(msg) {
        var item = document.createElement('li');
        item.textContent = msg;
        document.getElementById('messages').appendChild(item);
        window.scrollTo(0, document.body.scrollHeight);
      });

      socket.on('user update', function(updatedUsers) {
        JSON.parse(updatedUsers).forEach(uu => {
          const index = users.findIndex(u => u.id === uu.id)
          if (index > -1) {
            users[index] = uu;
          }
          else {
            users.push(uu);
          }
        });
        displayUsers();
      });

      socket.on('user disconnect', function(id) {
        const index = users.findIndex(u => u.id === id)
        if (index > -1) {
          users.splice(index, 1);
          displayUsers();
        }
      });
    </script>
  </body>
</html>